<!doctype html>
<html>
  <head>
    <title>Empty Web</title>
    <meta charset="utf-8">
    <link href="styles/styles.css" rel="stylesheet" type="text/css">    
  </head>
  <body>
    <h4>Welcome...</h4>
    <div id="error-log">
    </div>        

    <script type="text/javascript">
      console.log = (function (old_function, logger) { 
        return function (text) {
          old_function(text);
          const element = document.createElement("div");
          const txt = document.createTextNode(text);
          element.appendChild(txt);
          logger.appendChild(element);        
        };
      } (console.log.bind(console), document.getElementById("error-log")));
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
    <!-- <script src="lib/axios.js"></script> -->
    <script src="https://unpkg.com/systemjs@0.21.3/dist/system.js"></script>
    <script src="lib/systemjs.config.js"></script>
    <script type="text/javascript">
      function buildDependencyMap() {
        let dependencies = [];
        return new Promise((resolve, reject) => {
          // read the package.json file
          // console.log('attempting to read package.json');
          return axios.get('package.json').then(response => {
            const {status, data} = response;
            // console.log('package.json', data);
            // We are interested in the dependencies section.
            const uris = [];
            for (const [key, value] of Object.entries(data.dependencies)) {
              console.log(`${key} ${value}`);
              // Load package.json e.g. https://unpkg.com/lodash@4.17.4/package.json
              // Load manifest /?json e.g. https://unpkg.com/lodash@4.17.4/?json
              const pkgUri = `https://unpkg.com/${key}@${value}/package.json`;
              uris.push(axios.get(pkgUri));
              const jsonUri = `https://unpkg.com/${key}@${value}/?json`;
              uris.push(axios.get(jsonUri));
            }
            return Promise.all(uris).then(values => {
              for (let i = 0; i < values.length - 1; i += 2) {
              // for (const pkg of values) {
                const pkg = values[i];
                const dir = values[i + 1];
                let {browser, main, name, version} = pkg.data;
                const minName = `${name}.min.js`;
                const file = dir.data.files.find(f => f.path === `/${minName}`);
                if (file) {
                  main = minName;
                } else if (browser) {
                  main = browser;
                }
                // Now load the main entry e.g. https://unpkg.com/lodash@4.17.4/lodash.js
                const valueUri = `npm:${name}@${version}/${main}`;
                dependencies.push({key:name, value:valueUri});                
              }
              resolve(dependencies);
            });
          });
        });
      }
      buildDependencyMap().then(dependencies => {
        const map = {};
        console.log('dependencies', JSON.stringify(dependencies));
        dependencies.forEach(d => {
          map[d.key] = d.value;
          console.log(`${d.key} --> ${d.value}`);
        });
        console.log('map', map);
        System.config({
          map
        });		
        System.import('index.js');
        // console.log('ready...');
      });      
    </script>
  </body>
</html>
