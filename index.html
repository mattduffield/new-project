<!doctype html>
<html>
  <head>
    <title>Empty Web</title>
    <meta charset="utf-8">
    <link href="lib/highlight/styles/monokai-sublime.css" rel="stylesheet" type="text/css">
    <link href="styles/styles.css" rel="stylesheet" type="text/css">    
    <script src="lib/highlight/highlight.pack.js"></script>
    <script>
      hljs.initHighlightingOnLoad();
    </script>
  </head>
  <body aurelia-app="main">
    <h4>Welcome...</h4>
    <div id="logger"></div>        

    <script type="text/javascript">
      console.log = (function (old_function, logger) { 
        return function (...text) {
          old_function(...text);
          const pre = document.createElement("pre");
          const code = document.createElement("code");
          text.forEach(t => {
            let msg = '';
            if (Array.isArray(t)) {
              const arr = t.join(', ');
              msg = `[${arr}]`;
            } else if (typeof(t) === 'object') {
              msg = `${JSON.stringify(t, null, 2)}`;
            } else {
              msg = `${t}  `;
            }
            const txt = document.createTextNode(msg.trim());
            code.appendChild(txt);
          });
          pre.appendChild(code);
          logger.appendChild(pre);
          hljs.highlightBlock(logger);
        }
      } (console.log.bind(console), document.getElementById("logger")));
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
    <script src="https://unpkg.com/systemjs@0.21.3/dist/system.js"></script>
    <script src="systemjs.config.js"></script>
    <script type="text/javascript">
      function hashCode(s) {
        if (!s) return 0;
        var h = 0, l = s.length, i = 0;
        if ( l > 0 )
          while (i < l)
            h = (h << 5) - h + s.charCodeAt(i++) | 0;
        return h;
      }
      function buildDependencyMap() {
        return new Promise((resolve, reject) => {
          // read the package.json file
          return axios.get('package.json').then(response => {
            const {status, data} = response;
            // Compute a hash of the loaded package.json file
            const hash = hashCode(JSON.stringify(data.dependencies));
            // Next, compare the hash of the file with the hash stored
            const packageHash = localStorage.getItem('packageHash');
            if (packageHash && +packageHash === hash) {
              // Grab the existing stored map
              const packageMap = JSON.parse(localStorage.getItem('packageMap'));
              return resolve(packageMap);
            } 
            // Store the has of the package.json fiile
            localStorage.setItem('packageHash', hashCode(JSON.stringify(data.dependencies)));
            // We are interested in the dependencies section.
            const uris = [];
            for (const [key, value] of Object.entries(data.dependencies)) {
              console.log(`${key} ${value}`);
              // Load package.json e.g. https://unpkg.com/lodash@4.17.4/package.json
              // Load manifest /?json e.g. https://unpkg.com/lodash@4.17.4/?json
              const pkgUri = `https://unpkg.com/${key}@${value}/package.json`;
              uris.push(axios.get(pkgUri));
              const jsonUri = `https://unpkg.com/${key}@${value}/?json`;
              uris.push(axios.get(jsonUri));
            }
            return Promise.all(uris).then(values => {
              const map = {};
              for (let i = 0; i < values.length - 1; i += 2) {
                const pkg = values[i];
                const dir = values[i + 1];
                let {browser, main, name, version, jspm} = pkg.data;
                if (jspm) {
                  const jspmMain = jspm.main;
                  const dist = jspm.directories.dist;
                  main = `${dist}/${jspmMain}`;
                } else {
                  const minName = `${name}.min.js`;
                  const file = dir.data.files.find(f => f.path === `/${minName}`);
                  if (file) {
                    main = minName;
                  } else if (browser) {
                    main = browser;
                  }
                }
                if (!main) {
                  main = 'index.js';
                }
                // Now load the main entry e.g. https://unpkg.com/lodash@4.17.4/lodash.js
                const valueUri = `npm:${name}@${version}/${main}`;
                map[name] = valueUri;
              }
              localStorage.setItem('packageMap', JSON.stringify(map));
              return resolve(map);
            });
          });
        });
      }
      buildDependencyMap().then(map => {
        // console.log('map', map);
        console.log(map);
        System.config({
          map
        });
        System.import('aurelia-bootstrapper');        
        // System.import('aurelia-loader-default')
        //   .then(({ DefaultLoader }) => patchDefaultLoader(DefaultLoader))
        //   .then(() => System.import('aurelia-bootstrapper'));        
        // System.import('index.js');
        // console.log('ready...');
      });      
    </script>
  </body>
</html>
